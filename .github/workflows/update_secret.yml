name: Rotate RAN_SECRET

on:
  workflow_dispatch:  # Allows manual triggering of the workflow
  schedule:           # Optional: Can set a schedule to rotate regularly
    - cron: '0 0 * * *' # Runs every day at midnight UTC (optional, adjust as needed)

jobs:
  rotate-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate new secret
        id: generate-secret
        run: |
          # Generate a new random 64-character hexadecimal secret
          NEW_SECRET=$(openssl rand -hex 32)
          echo "New secret generated: $NEW_SECRET"
          echo "NEW_SECRET=${NEW_SECRET}" >> $GITHUB_ENV

      - name: Update GitHub secret
        run: |
          # Use GitHub's REST API to update the secret RAN_SECRET in the repository
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/RAN_SECRET \
            -d "{\"encrypted_value\":\"${NEW_SECRET}\"}"

      - name: Log new secret value
        run: echo "The new secret RAN_SECRET is: ${{ env.NEW_SECRET }}"
